<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Login - ROMA RP</title>
  <link rel="stylesheet" href="code.css" />
</head>
<body>
  <header class="nav">
    <div class="wrap container">
      <a class="brand" href="index.html"><img src="download.png" alt="Logo Roma RP" class="logo-small"></a>
  <button class="nav-toggle" aria-expanded="false" aria-label="Apri menu"> <span class="bar"></span> </button>
  <nav class="links" aria-label="Primaria">
        <a href="index.html">Home</a>
        <a href="chi-siamo.html">Chi Siamo</a>
        <a href="roleplay.html">RolePlay</a>
        <a href="negozio.html">Negozio</a>
        <a href="contatti.html" class="cta">Contattaci</a>
        <a id="nav-login-btn" class="btn nav-login" href="staff-login.html">Accedi</a>
      </nav>
    </div>
  </header>
  <script>
    (function(){
      const nav = document.querySelector('.nav'); const toggle = document.querySelector('.nav-toggle');
      if(toggle){ toggle.addEventListener('click', function(){ const opened = nav.classList.toggle('nav-open'); toggle.setAttribute('aria-expanded', opened ? 'true' : 'false'); }); }
      const staff = sessionStorage.getItem('rprp_staff'); if(staff){ const a = document.getElementById('nav-login-btn'); if(a){ a.textContent = staff; a.classList.add('profile'); a.href = 'staff-dashboard.html'; } }
    })();
  </script>
  <main class="container" style="max-width:920px;margin:3.2rem auto;">
    <section class="animate-fadein">
      <h1 class="m0">Area Staff ‚Äî Accesso</h1>
      <p class="mt1" style="color:var(--muted)">Questa √® la pagina di accesso riservata allo staff di ROMA RP. Attenzione: autenticazione demo client-side (Nessun backend).</p>
      <div class="auth-wrapper">
        <canvas id="bg-canvas" class="bg-canvas" aria-hidden="true"></canvas>
        <div id="confetti" aria-hidden="true"></div>
        <!-- Animated gold/purple particles overlay -->
        <div id="particles-overlay" style="pointer-events:none;position:absolute;inset:0;z-index:2;"></div>
        <div class="auth-card animate-fadein" style="margin:2.5rem auto 0 auto;max-width:480px;padding:2.8rem 2.2rem 2.2rem 2.2rem;border-radius:28px;background:linear-gradient(135deg,rgba(244,196,48,0.18) 0%,rgba(108,92,231,0.13) 100%),rgba(20,24,38,0.92);backdrop-filter:blur(14px) saturate(140%);box-shadow:0 16px 48px 0 rgba(108,92,231,0.18),0 2px 12px 0 rgba(244,196,48,0.18),0 1.5px 16px 0 #00000022;border:2.5px solid color-mix(in oklab,var(--accent) 30%,#6c5ce7 70%);position:relative;overflow:hidden;transition:box-shadow .22s, border-color .22s;">
          <div class="center" style="margin-bottom:1.2rem;">
            <span class="icon-anim" style="font-size:3.1rem;color:var(--accent-3);margin-right:.7rem;filter:drop-shadow(0 2px 12px #6c5ce755);transition:transform .4s;">üõ°Ô∏è</span>
            <div style="text-align:left;">
              <div style="font-size:1.22rem;font-weight:900;color:var(--text);letter-spacing:-.5px;text-shadow:0 2px 12px #6c5ce755,0 1px 0 #fff1;">Accesso Area Staff</div>
              <div style="color:var(--muted);font-size:.99rem;margin-top:.18rem;">Inserisci le tue credenziali per accedere agli strumenti staff.</div>
            </div>
          </div>
          <div class="field" style="margin-bottom:1.2rem;">
            <input id="staff-user" class="input input-glow" placeholder=" " aria-label="Nome utente staff" autocomplete="username" style="background:rgba(255,255,255,0.07);border:1.5px solid var(--accent-3);color:var(--text);font-size:1.09rem;box-shadow:0 2px 12px 0 rgba(108,92,231,0.08);transition:box-shadow .22s,border-color .22s;" />
            <label for="staff-user" class="floating-label" style="color:var(--accent-3);font-weight:700;">Nome utente <span class="mini-ico" style="font-size:1.1em;vertical-align:-2px;">üë§</span></label>
          </div>
          <div class="field" style="margin-bottom:1.2rem;">
            <input id="staff-pass" type="password" class="input input-glow" placeholder=" " aria-label="Password" autocomplete="current-password" style="background:rgba(255,255,255,0.07);border:1.5px solid var(--accent-3);color:var(--text);font-size:1.09rem;box-shadow:0 2px 12px 0 rgba(108,92,231,0.08);transition:box-shadow .22s,border-color .22s;" />
            <label for="staff-pass" class="floating-label" style="color:var(--accent-3);font-weight:700;">Password <span class="mini-ico" style="font-size:1.1em;vertical-align:-2px;">üîí</span></label>
          </div>
          <div style="display:flex;gap:.7rem;justify-content:flex-end;margin-top:1.1rem;">
            <a id="staff-cancel" class="btn outline btn-glow" href="index.html" style="border-radius:12px;font-weight:700;">Annulla</a>
            <button id="staff-submit" type="button" class="btn primary btn-glow" style="border-radius:12px;font-weight:800;background:linear-gradient(90deg,var(--accent-3) 0%,var(--accent) 100%);color:#fff;box-shadow:0 4px 18px 0 rgba(244,196,48,0.13),0 2px 12px 0 rgba(108,92,231,0.18);transition:background .18s,box-shadow .18s,transform .18s;">Accedi <span class="mini-ico" style="font-size:1.1em;vertical-align:-2px;">üöÄ</span></button>
          </div>
          <div id="auth-note" class="muted" style="margin-top:1.2rem;font-size:.99rem;text-align:center;letter-spacing:-.2px;">Nota: accesso demo. Per implementazione reale, integrare backend sicuro.</div>
        </div>
      </div>
      <style>
      /* Animazioni spettacolari e microinterazioni */
      .auth-card:hover .icon-anim { transform: scale(1.13) rotate(-8deg); filter:drop-shadow(0 4px 24px #f4c43088); }
      .input-glow:focus { box-shadow:0 0 0 4px #f4c43044,0 2px 12px 0 #6c5ce744; border-color:var(--accent); }
      .btn-glow:hover, .btn-glow:focus { box-shadow:0 0 16px 4px #f4c43055,0 2px 12px 0 #6c5ce744; filter:brightness(1.08) saturate(1.2); transform:scale(1.04); }
      .mini-ico { animation: bounceIco 1.6s infinite alternate cubic-bezier(.4,1.6,.4,1); }
      @keyframes bounceIco { 0%{transform:translateY(0);} 100%{transform:translateY(-4px) scale(1.13);} }
      </style>
      <script>
      // Particelle oro/viola animate
      (function(){
        const overlay = document.getElementById('particles-overlay');
        if(!overlay) return;
        const n = 22, colors = ['#f4c430','#6c5ce7','#fffbe6','#e73f3f'];
        for(let i=0;i<n;i++){
          const p = document.createElement('div');
          p.style.position='absolute';
          p.style.left = Math.random()*100+'%';
          p.style.top = Math.random()*100+'%';
          p.style.width = (8+Math.random()*16)+'px';
          p.style.height = p.style.width;
          p.style.borderRadius = '50%';
          p.style.background = colors[Math.floor(Math.random()*colors.length)];
          p.style.opacity = 0.13+Math.random()*0.18;
          p.style.filter = 'blur('+(2+Math.random()*6)+'px)';
          p.style.zIndex = 2;
          p.style.animation = `floatP${i} ${(2.5+Math.random()*2.5).toFixed(2)}s ease-in-out infinite alternate`;
          overlay.appendChild(p);
          const keyframes = `@keyframes floatP${i}{0%{transform:translateY(0) scale(1);}100%{transform:translateY(${Math.random()>0.5?'-':'+'}${16+Math.random()*32}px) scale(${1+Math.random()*0.18});}}`;
          const style = document.createElement('style'); style.innerHTML = keyframes; document.head.appendChild(style);
        }
      })();
      // Successo: glow animato sulla card
      function animateSuccess(){
        const card = document.querySelector('.auth-card');
        if(!card) return;
        card.animate([
          {boxShadow:card.style.boxShadow},
          {boxShadow:'0 0 32px 8px #f4c430cc,0 2px 12px 0 #6c5ce7cc'},
          {boxShadow:card.style.boxShadow}
        ],{duration:900,iterations:1});
      }
      // Hook su login riuscito
      const origShowModal = window.showModal;
      window.showModal = function(opts){
        origShowModal(opts);
        if(opts && opts.success) animateSuccess();
      };
      </script>
      <!-- Rich modal pop-up (permessi e azioni) -->
      <div id="modal-popup" class="modal-backdrop" aria-hidden="true">
        <div id="modal-content" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <div id="modal-icon" style="font-size:2.6rem;margin-bottom:.6rem;text-align:center;"></div>
          <h3 id="modal-title"></h3>
          <div id="modal-msg" class="muted" style="margin-bottom:.8rem;"></div>
          <div id="modal-perms" style="text-align:left;margin-top:.6rem;margin-bottom:.6rem;">
            <!-- Permissions list will be injected here -->
          </div>
          <div class="actions" style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem;">
            <button id="modal-close" class="btn outline">Chiudi</button>
            <button id="modal-go" class="btn primary">Vai al dashboard</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Demo staff list (client-only) ‚Äî for real sites, NEVER store credentials client-side.

    // Staff demo users with avatar and role
    const staffDemo = {
      "admin": { pass: "password123", name: "Admin", role: "Supporto", avatar: "download.png" },
      "moderatore": { pass: "mod2025", name: "Moderatore", role: "Moderatore", avatar: "image.png" },
      "imp": { pass: "imp2025", name: "Imp", role: "Amministrazione", avatar: "ima1ge.png" },
      "karatedieci": { pass: "francy09@", name: "Karate Dieci", role: "Sviluppatore", avatar: "download.png" },
      "baron": { pass: "baron1940", name: "Baron", role: "Amministrazione", avatar: "image.png" }
    };

    function isStaffValid(u,p){
      return staffDemo[u] && staffDemo[u].pass === p;
    }

    // helper to submit via click or Enter

    // Modal helpers (rich)
    function renderPermsForRole(role){
      const perms = {
        'Fondatore': [ ['‚≠ê', 'Accesso totale al pannello amministrativo'], ['üîß', 'Gestione plugin e server'], ['üßæ', 'Visualizza log completi'] ],
        'Moderatore': [ ['üõ°Ô∏è','Gestione segnalazioni e moderazione chat'], ['üîá','Sospensione e ban temporanei'], ['üì©','Gestione ticket utenti'] ],
        'Amministrazione': [ ['üß≠','Gestione ruoli e permessi'], ['üìä','Accesso statistiche interne'], ['üìå','Modifica comunicazioni ufficiali'] ],
        'Sviluppatore': [ ['üíª','Accesso codice e deploy demo'], ['üêû','Segnalazione e fix bug'], ['‚öôÔ∏è','Strumenti tecnici avanzati'] ],
        'Supporto': [ ['üìû','Risposta a ticket e aiuto utenti'], ['üîç','Analisi problemi'], ['üóÇÔ∏è','Documentazione utenti'] ]
      };
      return perms[role] || [['‚ÑπÔ∏è','Accesso staff di base']];
    }

    function showModal({icon,title,msg,success,role,cb}){
      const modal = document.getElementById('modal-popup');
      const prevActive = document.activeElement;
      document.getElementById('modal-icon').textContent = icon || '';
      document.getElementById('modal-title').textContent = title || '';
      // allow HTML in message for emphasis
      document.getElementById('modal-msg').innerHTML = msg || '';
      const permsEl = document.getElementById('modal-perms');
      permsEl.innerHTML = '';
      if(role){
        const list = renderPermsForRole(role);
        const ul = document.createElement('ul'); ul.style.paddingLeft = '1.05rem'; ul.style.margin = '0'; ul.style.listStyle = 'none';
        list.forEach(([emo,desc])=>{ const li = document.createElement('li'); li.style.marginBottom='.5rem'; li.innerHTML = `<div style="display:flex;gap:.6rem;align-items:flex-start"><span style="font-size:1.15rem">${emo}</span><div>${desc}</div></div>`; ul.appendChild(li); });
        permsEl.appendChild(ul);
      }
      modal.classList.add('show'); modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
      document.getElementById('modal-content').style.borderColor = success ? 'var(--accent)' : 'var(--accent-2)';
      document.getElementById('modal-title').style.color = success ? 'var(--accent)' : 'var(--accent-2)';
      document.getElementById('modal-icon').style.color = success ? 'var(--accent)' : 'var(--accent-2)';
      // focus management
      const closeBtn = document.getElementById('modal-close'); closeBtn.focus();
      closeBtn.onclick = function(){ modal.classList.remove('show'); modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); if(prevActive) prevActive.focus(); if(cb) cb(); };
      document.getElementById('modal-go').onclick = function(){ if(cb) cb(); else window.location.href='staff-dashboard.html'; };
      // close on ESC
      function escHandler(e){ if(e.key === 'Escape'){ closeBtn.click(); document.removeEventListener('keydown', escHandler); } }
      document.addEventListener('keydown', escHandler);
    }

    // Animazione loader
    function showLoader(btn, show) {
      if(show) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loader" style="display:inline-block;width:1.2em;height:1.2em;border:3px solid var(--accent);border-radius:50%;border-top:3px solid transparent;animation:spin .7s linear infinite;vertical-align:middle;"></span>';
      } else {
        btn.disabled = false;
        btn.textContent = 'Accedi';
      }
    }

    function submitLogin(){
      const rawU = document.getElementById('staff-user').value.trim();
      const u = rawU.toLowerCase();
      const pRaw = document.getElementById('staff-pass').value || '';
      const p = pRaw;
      const btn = document.getElementById('staff-submit');
      if(!u || !p){
        showModal({icon:'‚ùó',title:'Attenzione',msg:'Compila utente e password per l‚Äôaccesso.',success:false});
        shakeCard();
        return;
      }
      showLoader(btn, true);
      setTimeout(()=>{
        if(isStaffValid(u,p)){
          const user = staffDemo[u];
          sessionStorage.setItem('rprp_staff', u);
          sessionStorage.setItem('rprp_staff_name', user.name);
          sessionStorage.setItem('rprp_staff_role', user.role);
          sessionStorage.setItem('rprp_staff_avatar', user.avatar);
          // Create a friendly, emoji-filled modal describing what you can do
          const msg = `Ciao <strong>${user.name}</strong> ‚Äî hai effettuato l'accesso come <strong>${user.role}</strong>.<br>Di seguito sono elencati i permessi principali del tuo ruolo:`;
          showModal({icon:'üéâ',title:'Accesso riuscito',msg:msg,success:true,role:user.role,cb:()=>{ window.location.href='staff-dashboard.html'; }});
          launchConfetti();
        } else {
          showModal({icon:'‚ùå',title:'Errore',msg:'Credenziali non valide. Riprova.',success:false});
          shakeCard();
        }
        showLoader(btn, false);
      }, 900);
    }

    // Mostra/nascondi password e aggiunge micro UX
    (function(){
      const passInput = document.getElementById('staff-pass');
      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'pw-toggle';
      toggle.innerHTML = 'üëÅÔ∏è';
      toggle.setAttribute('aria-label','Mostra password');
      toggle.onmousedown = e => e.preventDefault();
      toggle.onclick = function(){
        passInput.type = passInput.type === 'password' ? 'text' : 'password';
        toggle.innerHTML = passInput.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      };
      passInput.parentNode.style.position = 'relative';
      passInput.parentNode.appendChild(toggle);
    })();

    // Background canvas animation
    (function(){
      const canvas = document.getElementById('bg-canvas'); if(!canvas) return;
      const ctx = canvas.getContext('2d'); let w=canvas.width=innerWidth, h=canvas.height=innerHeight;
      addEventListener('resize', ()=>{ w=canvas.width=innerWidth; h=canvas.height=innerHeight; });
      const drops = Array.from({length:80}).map(()=>({ x: Math.random()*w, y: Math.random()*h, r: 1+Math.random()*3, a: 0.08+Math.random()*0.4, hue: 40+Math.random()*40 }));
      function draw(){ ctx.clearRect(0,0,w,h); for(const d of drops){ d.x += Math.sin(Date.now()/3000 + d.r) * 0.3; d.y += Math.cos(Date.now()/2000 + d.r) * 0.2; ctx.beginPath(); ctx.fillStyle = `hsla(${d.hue},85%,60%,${d.a})`; ctx.ellipse(d.x, d.y, d.r*1.2, d.r, 0,0,Math.PI*2); ctx.fill(); if(d.x< -20) d.x=w+20; if(d.x>w+20) d.x=-20; if(d.y>h+20) d.y=-20; if(d.y<-20) d.y=h+20; } requestAnimationFrame(draw); }
      draw();
    })();

    // Confetti launcher
    function launchConfetti(){
      const container = document.getElementById('confetti'); if(!container) return; container.innerHTML='';
      const colors = ['#f4c430','#e73f3f','#6c5ce7','#27ae60','#fffbe6'];
      for(let i=0;i<60;i++){ const el = document.createElement('div'); el.className='confetti-piece'; el.style.left = Math.random()*100 + '%'; el.style.top = '-10%'; el.style.background = colors[Math.floor(Math.random()*colors.length)]; el.style.width = (6+Math.random()*12)+'px'; el.style.height = (8+Math.random()*16)+'px'; el.style.transform = `rotate(${Math.random()*360}deg)`; el.style.animation = `confetti-fall ${1.6+Math.random()*1.8}s cubic-bezier(.2,.9,.2,1) forwards`; container.appendChild(el); }
      setTimeout(()=>{ container.innerHTML=''; }, 3800);
    }

    function shakeCard(){ const card = document.querySelector('.auth-card'); if(!card) return; card.animate([{transform:'translateX(0)'},{transform:'translateX(-8px)'},{transform:'translateX(8px)'},{transform:'translateX(0)'}],{duration:260,iterations:1}); }

    document.getElementById('staff-submit').addEventListener('click', submitLogin);

    // Submit on Enter in either input
    ['staff-user','staff-pass'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ submitLogin(); } });
    });

    // If already logged in, go to dashboard
    if(sessionStorage.getItem('rprp_staff')){
      window.location.href = 'staff-dashboard.html';
    }
    // --- Shared report modal & button (same UX used across site) ---
    (function(){
      // Toast helper (small, non-blocking notices)
      function showToast(msg, type='info'){
        let container = document.getElementById('toast-container');
        if(!container){ container = document.createElement('div'); container.id='toast-container'; container.style.position='fixed'; container.style.right='18px'; container.style.bottom='92px'; container.style.zIndex=10010; document.body.appendChild(container); }
        const t = document.createElement('div'); t.className = 'toast'; t.style.marginTop = '.6rem'; t.style.padding = '.7rem 1rem'; t.style.borderRadius = '10px'; t.style.background = type==='error' ? 'rgba(231,63,63,0.12)' : type==='success' ? 'rgba(39,174,96,0.12)' : 'rgba(255,255,255,0.03)'; t.style.borderLeft = type==='error' ? '4px solid #e73f3f' : type==='success' ? '4px solid #27ae60' : '4px solid var(--accent)'; t.textContent = msg; container.appendChild(t); setTimeout(()=>{ t.style.opacity=0; t.style.transform='translateY(-6px)'; setTimeout(()=>t.remove(),360); }, 3600);
      }

      const html = `
      <div id="report-modal" class="modal-backdrop" style="display:none;align-items:center;justify-content:center;" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="report-title">
          <h3 id="report-title">Segnala / Apri Ticket</h3>
          <div class="muted">Compila il modulo per inviare una segnalazione allo staff. (Demo: i messaggi sono salvati localmente)</div>
          <form id="report-form" style="margin-top:.8rem;display:grid;gap:.6rem;">
            <label class="sr-only" for="rep-name">Nome</label>
            <input id="rep-name" class="input" placeholder="Nome (es. Mario Rossi)" required />
            <label class="sr-only" for="rep-discord">Discord</label>
            <input id="rep-discord" class="input" placeholder="Discord (es. Nick#1234)" required />
            <label class="sr-only" for="rep-type">Tipo</label>
            <select id="rep-type" class="input"><option value="ticket">Ticket</option><option value="segnalazione">Segnalazione</option><option value="bug">Bug</option></select>
            <label class="sr-only" for="rep-desc">Descrizione</label>
            <textarea id="rep-desc" class="input" placeholder="Descrivi il problema / dettaglio..." style="min-height:100px;padding:10px" required></textarea>
            <div id="rep-error" role="alert" aria-live="assertive" style="color:#e73f3f;display:none;font-size:.95rem;"></div>
          </form>
          <div class="actions" style="margin-top:.8rem;justify-content:flex-end;display:flex;gap:.6rem;">
            <button id="rep-cancel" class="btn outline">Annulla</button>
            <button id="rep-send" class="btn primary">Invia Segnalazione</button>
          </div>
        </div>
      </div>
      <button id="report-btn" aria-haspopup="dialog" aria-controls="report-modal" title="Segnala" style="position:fixed;right:18px;bottom:18px;z-index:9999;border-radius:999px;padding:.8rem 1rem;background:var(--accent);color:#111;border:none;box-shadow:0 10px 30px rgba(0,0,0,.45);">‚ö†Ô∏è Segnala</button>
      `;
      const div = document.createElement('div'); div.innerHTML = html; document.body.appendChild(div);

      const modal = document.getElementById('report-modal');
      const firstFocusableSelector = 'input,select,textarea,button';
      function trapFocus(e){
        const focusable = Array.from(modal.querySelectorAll(firstFocusableSelector)).filter(n=>n.offsetParent!==null);
        if(focusable.length===0) return;
        const first = focusable[0]; const last = focusable[focusable.length-1];
        if(e.key === 'Tab'){
          if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      }

      function openReport(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); const f = document.getElementById('rep-name'); f.focus(); document.addEventListener('keydown', trapFocus); document.addEventListener('keydown', escHandler); }
      function closeReport(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', trapFocus); document.removeEventListener('keydown', escHandler); }
      function escHandler(e){ if(e.key === 'Escape'){ closeReport(); } }

      document.getElementById('report-btn').addEventListener('click', openReport);
      document.getElementById('rep-cancel').addEventListener('click', function(){ closeReport(); showToast('Invio annullato', 'info'); });

      // Inline validation and send handling
      const sendBtn = document.getElementById('rep-send');
      const form = document.getElementById('report-form');
      const errEl = document.getElementById('rep-error');
      let sending = false;
      sendBtn.addEventListener('click', async function(){
        if(sending) return;
        errEl.style.display='none';
        const name = document.getElementById('rep-name').value.trim();
        const discord = document.getElementById('rep-discord').value.trim();
        const type = document.getElementById('rep-type').value;
        const desc = document.getElementById('rep-desc').value.trim();
        if(!name || !discord || !desc){ errEl.textContent='Compila tutti i campi richiesti.'; errEl.style.display='block'; return; }
        // simple discord tag validation
        if(!/^[^\s]{3,32}#\d{4,6}$/.test(discord) && discord.indexOf('#') === -1){ /* allow non-tag too */ }
        sending = true; sendBtn.disabled = true; sendBtn.textContent = 'Invio...';
        try{
          const id = 'rprp_' + Date.now() + '_' + Math.floor(Math.random()*10000);
          const payload = { id, name, discord, type, desc, ts: Date.now(), source: window.location.pathname, read: false };
          const key = 'rprp_reports';
          const arr = JSON.parse(localStorage.getItem(key) || '[]'); arr.push(payload); localStorage.setItem(key, JSON.stringify(arr));
          closeReport(); showToast('Segnalazione inviata', 'success');
          // clear form
          form.reset();
        } catch(e){ console.error(e); errEl.textContent = 'Errore durante l\'invio. Riprova.'; errEl.style.display='block'; showToast('Errore invio', 'error'); }
        sending = false; sendBtn.disabled = false; sendBtn.textContent = 'Invia Segnalazione';
      });

      // Accessibility: close modal on backdrop click
      modal.addEventListener('click', function(e){ if(e.target === modal) closeReport(); });
    })();
  </script>
  <!-- Site announcement renderer (shows site-wide popup if published by staff) -->
  <script>
  (function(){
    try{
      function removeOverlay(){ const existing = document.getElementById('site-ann-overlay'); if(existing) existing.remove(); }
      function renderSiteAnnouncement(ann){ try{
        removeOverlay();
        if(!ann || !ann.active) return;
        if(ann.expiresAt && Date.now() > ann.expiresAt) return;
        const dismissKey = 'rprp_site_announcement_dismissed_' + (ann.id || 'default');
        if(sessionStorage.getItem(dismissKey)) return;
        if(document.getElementById('site-ann-overlay')) return;
        const overlay = document.createElement('div'); overlay.id = 'site-ann-overlay';
        const card = document.createElement('div'); card.className = 'site-announcement';
        const closeBtn = document.createElement('button'); closeBtn.className = 'close-btn'; closeBtn.innerHTML = '‚úï';
        closeBtn.addEventListener('click', ()=>{ sessionStorage.setItem(dismissKey,'1'); overlay.remove(); });
        const title = document.createElement('h3'); title.innerHTML = ann.title || 'Annuncio';
        const body = document.createElement('div'); body.className = 'body'; body.innerHTML = ann.html || ann.text || '';
        const actions = document.createElement('div'); actions.className = 'actions';
        const ok = document.createElement('button'); ok.className = 'btn primary'; ok.textContent = 'Chiudi'; ok.addEventListener('click', ()=>{ sessionStorage.setItem(dismissKey,'1'); overlay.remove(); });
        actions.appendChild(ok);
        card.appendChild(closeBtn); card.appendChild(title); card.appendChild(body); card.appendChild(actions);
        overlay.appendChild(card);
        document.body.appendChild(overlay);
        setTimeout(()=> overlay.classList.add('show'), 10);
      }catch(e){ console.error('renderSiteAnnouncement failed', e); }}
      function loadAndRender(){ try{ const raw = localStorage.getItem('rprp_site_announcement'); if(!raw){ removeOverlay(); return; } const ann = JSON.parse(raw); renderSiteAnnouncement(ann); }catch(e){ console.error('loadAndRender failed', e); } }
      loadAndRender();
      window.addEventListener('storage', function(e){ if(e.key === 'rprp_site_announcement'){ try{ if(!e.newValue){ removeOverlay(); return; } loadAndRender(); }catch(err){ console.error('storage listener error', err); } } });
      window.renderSiteAnnouncement = function(ann){ try{ renderSiteAnnouncement(ann); }catch(e){} };
    }catch(e){ console.error('Announcement render failed', e); }
  })();
  </script>
</body>
</html>